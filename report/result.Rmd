```{r, include=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggtree)
library(lubridate)
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
parse_mle <- function(path)
{
	result <-
		read_lines(path) %>% 
		enframe(name = NULL) %>% 
		filter(startsWith(value, "log")) %>%
		pull("value") %>%
		str_remove(".* =") %>% 
		as.numeric()
	
	list(PS = result[1], SS = result[2])
}

calc_bayes_factor <- function(root)
{
	list.files(root, "*.mle.result.log", full.names = T) %>%
		enframe(name = NULL, value = "path") %>% 
		mutate(name = basename(path)) %>%
		separate("name", c("clock", "coalescent"), extra = "drop") %>%
		bind_cols(bind_rows(lapply(.$path, parse_mle))) %>% 
		mutate(
			`BF (PS)` = PS - PS[which(clock == "str" & coalescent == "con")],
			`BF (SS)` = SS - SS[which(clock == "str" & coalescent == "con")]
		)
}
```

```{r}
bf <-
	dir("..", full.names = T, recursive = T, include.dirs = T, pattern = "beast") %>%
	lapply(calc_bayes_factor) %>%
	bind_rows() %>%
	mutate(lab = str_extract(path, "exp-\\d+")) %>%
	arrange(lab, desc(`BF (PS)`)) %>%
	select(lab, everything())

knitr::kable(select(bf, -path))
```

```{r}
tree <-
	filter(bf, lab == "exp-1") %>% pull(path) %>% head(1) %>% 
	str_replace(".mle.*", ".mcc.tree") %>% read.beast()

tip.date <-
	tree@phylo$tip.label %>% 
	enframe(name = NULL) %>% 
	separate(value, c("lab", "val"), "_") %>% 
	mutate_at("val", as.Date) %>%
	pull(val)

year1 <- year(min(tip.date - years(ceiling(max(tree@data$height, na.rm = T)))))
year2 <- year(max(tip.date))
breaks <- unique(c(year1, year(tip.date)))
```

```{r, fig.width=10, fig.height=8}
ggtree(tree, aes(color = rate), mrsd = max(tip.date), size = 1) +
	geom_range(range = "length_0.95_HPD", color = "red", alpha = 0.5, size = 2) +
	geom_nodelab(aes(x = branch, label = round(posterior, 2)), vjust = -0.5, size = 3, color = "black") +
	geom_tiplab(align = TRUE, linesize = 0.5, color = "black") + 
	scale_color_continuous(
		low = "darkgreen", high = "red", 
		guide = guide_legend(
			label.position = "bottom", 
			label.hjust = 0.5, label.vjust = 0.5, 
			label.theme = element_text(size = 8, angle = 90)
		)
	) +
	scale_x_continuous(breaks = breaks, minor_breaks = year1:year2) +
	theme_tree2() +
	theme(
		panel.grid.major.x = element_line(),
		panel.grid.minor.x = element_line(color = "grey"),
		axis.text.x = element_text(angle = 90, vjust = 0.5),
		legend.position = "bottom"
	)
```

```{r, fig.width=10}
# tree@data %>%
# 	select(height_median, rate_median) %>%
# 	filter(complete.cases(.)) %>%
# 	ggplot(aes(height_median, rate_median)) +
# 	geom_point() +
# 	theme_minimal()
nodeid(tree, c(tree@phylo$tip.label)) %>%
	enframe(name = NULL, value = "node") %>%
	merge(tree@data) %>%
	mutate(date = tip.date) %>%
	select(date, rate_median) %>%
	ggplot(aes(date, rate_median)) +
	geom_point() +
	theme_minimal()
```

```{r}

```

